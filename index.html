<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Bot Y√∂neticisi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            min-height: 600px;
        }

        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 30px;
        }

        .chat-area {
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .bot-list {
            margin-bottom: 30px;
        }

        .bot-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .bot-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .bot-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .bot-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .bot-username {
            color: #6c757d;
            font-size: 0.9em;
        }

        .chat-messages {
            flex: 1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 400px;
            border: 1px solid #e9ecef;
        }

        .message {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
        }

        .message-header {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 600;
            color: #667eea;
        }

        .message-time {
            font-size: 0.8em;
            color: #6c757d;
            margin-left: auto;
        }

        .message-text {
            color: #333;
        }

        .send-area {
            display: flex;
            gap: 12px;
            align-items: end; 
        }

        .send-area .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .status {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .send-area {
                flex-direction: column; 
                align-items: stretch;
            }

            .file-upload-section {
                flex-basis: auto !important; 
                width: 100%;
            }
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        .file-upload-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-basis: 150px; 
            min-width: 120px; 
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #1565c0;
        }

        .info-box h4 {
            margin-bottom: 8px;
            color: #0d47a1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Telegram Bot Y√∂neticisi</h1>
            <p>Botlarƒ±nƒ±zƒ± y√∂netin ve mesajla≈üƒ±n</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="info-box">
                    <h4>‚ÑπÔ∏è √ñnemli Bilgi</h4>
                    <p>Telegram Bot API'si sadece <strong>yeni mesajlarƒ±</strong> √ßeker. Eski mesaj ge√ßmi≈üini g√∂rmek i√ßin:</p>
                    <ul style="margin-top: 8px; margin-left: 20px;">
                        <li>Bota yeni bir mesaj g√∂nderin</li>
                        <li>Botunuzu bir gruba ekleyin</li>
                        <li>Botla etkile≈üim ba≈ülatƒ±n</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label>Bot Token Ekle</label>
                    <input type="text" id="botToken" placeholder="Bot token'ƒ±nƒ±zƒ± girin...">
                </div>
                
                <button class="btn" onclick="addBot()">
                    <span id="addBotText">Bot Ekle</span>
                    <span id="addBotLoader" class="loading" style="display: none;"></span>
                </button>

                <div class="status" id="status"></div>

                <div class="bot-list">
                    <h3 style="margin-bottom: 15px; color: #333;">Botlarƒ±m</h3>
                    <div id="botList">
                        <div class="empty-state">
                            <h4>Hen√ºz bot eklenmemi≈ü</h4>
                            <p>Yukarƒ±dan bot token'ƒ± ekleyerek ba≈ülayƒ±n</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-area">
                <div id="chatHeader" style="display: none; margin-bottom: 20px;">
                    <h3 id="selectedBotName">Bot Se√ß</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="refreshMessages()" id="refreshBtn">
                            üîÑ Yeni Mesajlarƒ± √áek
                        </button>
                        <button class="btn btn-secondary" onclick="clearMessageHistory()" id="clearBtn">
                            üóëÔ∏è Ge√ßmi≈üi Temizle
                        </button>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">
                        <h4>Bot se√ßin</h4>
                        <p>Sol taraftan bir bot se√ßerek mesajla≈ümaya ba≈ülayƒ±n</p>
                    </div>
                </div>

                <div class="send-area" id="sendArea" style="display: none;">
                    <div class="file-upload-section">
                        <input type="file" id="mediaFile" accept="image/*,audio/*,video/*,application/pdf" style="display: none;">
                        <button class="btn btn-secondary" onclick="document.getElementById('mediaFile').click()" style="width: 100%;">
                            üìé Dosya Ekle
                        </button>
                        <div id="selectedFileName" style="font-size: 0.9em; color: #555; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">Dosya se√ßilmedi</div>
                        <button class="btn btn-danger" id="clearMediaFileBtn" onclick="clearMediaFile()" style="font-size: 12px; padding: 6px 12px; display: none;">
                            ‚úñÔ∏è Kaldƒ±r
                        </button>
                    </div>

                    <div class="form-group">
                        <textarea id="messageText" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." rows="3"></textarea>
                    </div>
                    <button class="btn" onclick="sendMessage()">
                        <span id="sendText">G√∂nder</span>
                        <span id="sendLoader" class="loading" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global deƒüi≈ükenler
        let bots = [];
        let selectedBot = null;
        const LOCAL_STORAGE_KEY = 'telegramBots';
        const MESSAGE_STORAGE_KEY = 'telegramMessages';
        let selectedMediaFile = null; 
        let lastUpdateId = {}; // Her bot i√ßin ayrƒ± lastUpdateId
        const mediaUrlCache = new Map(); 

        // Helper: localStorage'a botlarƒ± kaydet
        function saveBotsToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(bots));
        }

        // Helper: localStorage'dan botlarƒ± y√ºkle
        function loadBotsFromLocalStorage() {
            const storedBots = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedBots) {
                try {
                    bots = JSON.parse(storedBots);
                } catch (e) {
                    console.error("Stored bots data corrupted, resetting:", e);
                    bots = [];
                }
            } else {
                bots = [];
            }
        }

        // Helper: Mesajlarƒ± localStorage'a kaydet
        function saveMessagesToLocalStorage() {
            const messages = {};
            document.querySelectorAll('.message').forEach((msgEl, index) => {
                if (selectedBot) {
                    if (!messages[selectedBot.id]) messages[selectedBot.id] = [];
                    messages[selectedBot.id].push(msgEl.outerHTML);
                }
            });
            
            const existingMessages = JSON.parse(localStorage.getItem(MESSAGE_STORAGE_KEY) || '{}');
            const mergedMessages = { ...existingMessages, ...messages };
            localStorage.setItem(MESSAGE_STORAGE_KEY, JSON.stringify(mergedMessages));
        }

        // Helper: Mesajlarƒ± localStorage'dan y√ºkle
        function loadMessagesFromLocalStorage() {
            if (!selectedBot) return;
            
            const storedMessages = localStorage.getItem(MESSAGE_STORAGE_KEY);
            if (storedMessages) {
                try {
                    const messages = JSON.parse(storedMessages);
                    if (messages[selectedBot.id]) {
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.innerHTML = messages[selectedBot.id].join('');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        return true; // Mesajlar y√ºklendi
                    }
                } catch (e) {
                    console.error("Stored messages data corrupted:", e);
                }
            }
            return false; // Hi√ß mesaj yoktu
        }

        // Helper: Mesaj ge√ßmi≈üini temizle
        function clearMessageHistory() {
            if (!selectedBot) return;
            
            if (confirm('Bu botun mesaj ge√ßmi≈üini temizlemek istediƒüinizden emin misiniz?')) {
                const storedMessages = JSON.parse(localStorage.getItem(MESSAGE_STORAGE_KEY) || '{}');
                delete storedMessages[selectedBot.id];
                localStorage.setItem(MESSAGE_STORAGE_KEY, JSON.stringify(storedMessages));
                
                lastUpdateId[selectedBot.id] = 0;
                
                document.getElementById('chatMessages').innerHTML = `
                    <div class="empty-state">
                        <h4>Mesaj ge√ßmi≈üi temizlendi</h4>
                        <p>Yeni mesajlarƒ± g√∂rmek i√ßin "Yeni Mesajlarƒ± √áek" butonuna tƒ±klayƒ±n</p>
                    </div>
                `;
                
                showStatus('Mesaj ge√ßmi≈üi temizlendi', 'success');
            }
        }

        // Helper: Durum mesajlarƒ±nƒ± g√∂ster
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Helper: Y√ºklenme durumunu y√∂net
        function setLoading(elementId, textId, loading) {
            const loader = document.getElementById(elementId);
            const text = document.getElementById(textId);
            if (loading) {
                loader.style.display = 'inline-block';
                text.style.display = 'none';
            } else {
                loader.style.display = 'none';
                text.style.display = 'inline';
            }
        }

        // Bot ekleme fonksiyonu
        async function addBot() {
            const token = document.getElementById('botToken').value.trim();
            if (!token) {
                showStatus('L√ºtfen bot token\'ƒ±nƒ± girin', 'error');
                return;
            }

            setLoading('addBotLoader', 'addBotText', true);

            try {
                const response = await fetch(`https://api.telegram.org/bot${token}/getMe`);
                const data = await response.json();
                
                if (data.ok) {
                    const bot = {
                        token: token,
                        id: data.result.id,
                        name: data.result.first_name,
                        username: data.result.username
                    };

                    if (bots.find(b => b.id === bot.id)) {
                        showStatus('Bu bot zaten eklenmi≈ü', 'error');
                        setLoading('addBotLoader', 'addBotText', false);
                        return;
                    }

                    bots.push(bot);
                    lastUpdateId[bot.id] = 0; // Yeni bot i√ßin lastUpdateId ba≈ülat
                    saveBotsToLocalStorage(); 
                    updateBotList();
                    document.getElementById('botToken').value = '';
                    showStatus(`${bot.name} (@${bot.username}) ba≈üarƒ±yla eklendi`, 'success');
                } else {
                    showStatus('Ge√ßersiz bot token\'ƒ±: ' + (data.description || 'Bilinmeyen Hata'), 'error');
                }
            } catch (error) {
                showStatus('Bot eklenirken hata olu≈ütu: ' + error.message, 'error');
            } finally {
                setLoading('addBotLoader', 'addBotText', false);
            }
        }

        // Bot listesini g√ºncelleme fonksiyonu
        function updateBotList() {
            const botList = document.getElementById('botList');
            if (bots.length === 0) {
                botList.innerHTML = `
                    <div class="empty-state">
                        <h4>Hen√ºz bot eklenmemi≈ü</h4>
                        <p>Yukarƒ±dan bot token'ƒ± ekleyerek ba≈ülayƒ±n</p>
                    </div>
                `;
                return;
            }

            botList.innerHTML = bots.map(bot => `
                <div class="bot-item ${selectedBot && selectedBot.id === bot.id ? 'active' : ''}" 
                     onclick="selectBot('${bot.id}')">
                    <div class="bot-name">${bot.name}</div>
                    <div class="bot-username">@${bot.username}</div>
                    <button class="btn btn-danger" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;" 
                            onclick="removeBot('${bot.id}', event)">
                        üóëÔ∏è Sil
                    </button>
                </div>
            `).join('');
        }

        // Bot silme fonksiyonu
        function removeBot(botId, event) {
            event.stopPropagation();
            if (confirm('Bu botu silmek istediƒüinizden emin misiniz?')) {
                bots = bots.filter(bot => bot.id !== parseInt(botId));
                saveBotsToLocalStorage(); 
                
                // Mesaj ge√ßmi≈üini de sil
                const storedMessages = JSON.parse(localStorage.getItem(MESSAGE_STORAGE_KEY) || '{}');
                delete storedMessages[parseInt(botId)];
                localStorage.setItem(MESSAGE_STORAGE_KEY, JSON.stringify(storedMessages));
                
                delete lastUpdateId[parseInt(botId)];

                if (selectedBot && selectedBot.id === parseInt(botId)) {
                    selectedBot = null;
                    document.getElementById('chatHeader').style.display = 'none';
                    document.getElementById('sendArea').style.display = 'none';
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="empty-state">
                            <h4>Bot se√ßin</h4>
                            <p>Sol taraftan bir bot se√ßerek mesajla≈ümaya ba≈ülayƒ±n</p>
                        </div>
                    `;
                }
                updateBotList();
                showStatus('Bot silindi', 'success');
            }
        }

        // Bot se√ßme fonksiyonu
        function selectBot(botId) {
            selectedBot = bots.find(bot => bot.id === parseInt(botId));
            if (selectedBot) {
                document.getElementById('selectedBotName').textContent = selectedBot.name;
                document.getElementById('chatHeader').style.display = 'flex';
                document.getElementById('chatHeader').style.justifyContent = 'space-between';
                document.getElementById('chatHeader').style.alignItems = 'center';
                document.getElementById('sendArea').style.display = 'flex';
                updateBotList(); 
                
                if (!lastUpdateId[selectedBot.id]) {
                    lastUpdateId[selectedBot.id] = 0;
                }
                
                mediaUrlCache.clear(); // Yeni bot se√ßildiƒüinde √∂nbelleƒüi temizle
                
                // √ñnce localStorage'dan mesajlarƒ± y√ºklemeye √ßalƒ±≈ü
                const messagesLoaded = loadMessagesFromLocalStorage();
                
                if (!messagesLoaded) {
                    // Eƒüer localStorage'da mesaj yoksa, API'den √ßekmeye √ßalƒ±≈ü
                    refreshMessages();
                } else {
                    showStatus('Kaydedilen mesajlar y√ºklendi. Yeni mesajlarƒ± g√∂rmek i√ßin "Yeni Mesajlarƒ± √áek" butonuna tƒ±klayƒ±n.', 'info');
                }
            }
        }

        // Mesajlarƒ± yenileme (√ßekme) fonksiyonu - D√úZELTME
        async function refreshMessages() {
            if (!selectedBot) return;

            const chatMessages = document.getElementById('chatMessages');
            const currentBotId = selectedBot.id;
            
            // ƒ∞lk y√ºkleme kontrol√º
            const isFirstLoad = lastUpdateId[currentBotId] === 0;
            
            if (isFirstLoad) {
                chatMessages.innerHTML = `
                    <div class="empty-state">
                        <h4>Yeni mesajlar kontrol ediliyor...</h4>
                        <span class="loading" style="display: inline-block; margin-top: 10px;"></span>
                    </div>
                `;
            }

            try {
                let url = `https://api.telegram.org/bot${selectedBot.token}/getUpdates`;
                
                // Doƒüru offset kullanƒ±mƒ±
                if (lastUpdateId[currentBotId] > 0) {
                    url += `?offset=${lastUpdateId[currentBotId] + 1}&timeout=2&limit=100`;
                } else {
                    // ƒ∞lk y√ºklemede, sadece bekleyen g√ºncellemeleri √ßek
                    url += `?timeout=2&limit=100`;
                }

                const response = await fetch(url);
                const data = await response.json();
                
                if (data.ok) {
                    if (data.result.length > 0) {
                        // ƒ∞lk y√ºklemede mesaj alanƒ±nƒ± temizle
                        if (isFirstLoad) {
                            chatMessages.innerHTML = ''; 
                        }
                        
                        await displayMessages(data.result); 
                        
                        // En b√ºy√ºk update_id'yi bul ve lastUpdateId'yi g√ºncelle
                        const maxUpdateId = Math.max(...data.result.map(update => update.update_id));
                        lastUpdateId[currentBotId] = Math.max(lastUpdateId[currentBotId], maxUpdateId);
                        
                        // Mesajlarƒ± localStorage'a kaydet
                        saveMessagesToLocalStorage();
                        
                        showStatus(`${data.result.length} yeni g√ºncelleme alƒ±ndƒ±`, 'success');
                    } else {
                        if (isFirstLoad) {
                            chatMessages.innerHTML = `
                                <div class="empty-state">
                                    <h4>Hen√ºz mesaj yok</h4>
                                    <p>Bu bot i√ßin hen√ºz bekleyen g√ºncelleme bulunmuyor.</p>
                                    <p><strong>Not:</strong> Telegram Bot API'si sadece botunuza g√∂nderilen yeni mesajlarƒ± √ßeker.</p>
                                    <p>Mesaj g√∂rmek i√ßin:</p>
                                    <ul style="text-align: left; margin-top: 10px;">
                                        <li>Telegram'da bota yeni bir mesaj g√∂nderin</li>
                                        <li>Botu bir gruba ekleyip mesaj g√∂nderin</li>
                                        <li>Bot komutlarƒ±nƒ± kullanƒ±n</li>
                                    </ul>
                                </div>
                            `;
                        } else {
                            showStatus('Yeni mesaj bulunmuyor', 'info');
                        }
                    }
                } else {
                    showStatus('Mesajlar y√ºklenirken hata olu≈ütu: ' + (data.description || 'Bilinmeyen Hata'), 'error');
                    if (isFirstLoad) {
                        chatMessages.innerHTML = `
                            <div class="empty-state">
                                <h4>Hata olu≈ütu</h4>
                                <p>${data.description || 'API\'den hata yanƒ±tƒ± alƒ±ndƒ±.'}</p>
                                <p>Bot token'ƒ±nƒ±n doƒüru olduƒüundan ve bot izinlerinin uygun olduƒüundan emin olun.</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                showStatus('Aƒü hatasƒ±: ' + error.message, 'error');
                if (isFirstLoad) {
                    chatMessages.innerHTML = `
                        <div class="empty-state">
                            <h4>Aƒü hatasƒ± olu≈ütu</h4>
                            <p>ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.</p>
                            <p>Bazƒ± aƒülarda Telegram API'sine eri≈üim engellenebilir.</p>
                        </div>
                    `;
                }
            }
        }

        // file_id'den dosya indirme URL'si alma fonksiyonu
        async function getFileDownloadUrl(botToken, fileId) {
            if (mediaUrlCache.has(fileId)) {
                return mediaUrlCache.get(fileId);
            }

            try {
                const response = await fetch(`https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`);
                const data = await response.json();
                if (data.ok && data.result && data.result.file_path) {
                    const fileUrl = `https://api.telegram.org/file/bot${botToken}/${data.result.file_path}`;
                    mediaUrlCache.set(fileId, fileUrl); 
                    return fileUrl;
                } else {
                    console.error('Dosya yolu alƒ±namadƒ±:', data.description || 'Bilinmeyen Hata', 'File ID:', fileId);
                    return null;
                }
            } catch (error) {
                console.error('Dosya yolu alƒ±nƒ±rken hata olu≈ütu:', error, 'File ID:', fileId);
                return null;
            }
        }

        // Mesajlarƒ± g√∂r√ºnt√ºleme fonksiyonu
        async function displayMessages(updates) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messagesPromises = updates.map(async update => {
                if (update.message) {
                    const message = update.message;
                    const date = new Date(message.date * 1000);
                    let messageContent = '';
                    let fileUrl = null;
                    let fileId = null;

                    if (message.text) {
                        messageContent = message.text;
                    } else if (message.photo) {
                        fileId = message.photo[message.photo.length - 1].file_id;
                        fileUrl = await getFileDownloadUrl(selectedBot.token, fileId);
                        if (fileUrl) {
                            messageContent = `<img src="${fileUrl}" alt="Fotoƒüraf" style="max-width:100%; height:auto; border-radius: 8px;">`;
                        } else {
                            messageContent = `Fotoƒüraf y√ºklenemedi. File ID: ${fileId}`;
                        }
                        if (message.caption) messageContent += `<p>${message.caption}</p>`;
                    } else if (message.video) {
                        fileId = message.video.file_id;
                        fileUrl = await getFileDownloadUrl(selectedBot.token, fileId);
                        if (fileUrl) {
                            messageContent = `<video controls src="${fileUrl}" style="max-width:100%; height:auto; border-radius: 8px;"></video>`;
                        } else {
                            messageContent = `Video y√ºklenemedi. File ID: ${fileId}`;
                        }
                        if (message.caption) messageContent += `<p>${message.caption}</p>`;
                    } else if (message.audio) {
                        fileId = message.audio.file_id;
                        fileUrl = await getFileDownloadUrl(selectedBot.token, fileId);
                        if (fileUrl) {
                            messageContent = `<audio controls src="${fileUrl}" style="width:100%;"></audio>`;
                        } else {
                            messageContent = `Ses dosyasƒ± y√ºklenemedi. File ID: ${fileId}`;
                        }
                        if (message.caption) messageContent += `<p>${message.caption}</p>`;
                    } else if (message.document) {
                         fileId = message.document.file_id;
                         fileUrl = await getFileDownloadUrl(selectedBot.token, fileId);
                         if (fileUrl) {
                            messageContent = `<a href="${fileUrl}" target="_blank" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: #667eea;"><span style="font-size: 1.5em;">üìÑ</span>${message.document.file_name}</a>`;
                         } else {
                             messageContent = `Belge y√ºklenemedi. File ID: ${fileId}`;
                         }
                         if (message.caption) messageContent += `<p>${message.caption}</p>`;
                    }

                    return {
                        senderName: message.from.first_name,
                        senderUsername: message.from.username || 'N/A',
                        time: date.toLocaleString('tr-TR'),
                        content: messageContent
                    };
                }
                return null; 
            });

            const messagesToRender = await Promise.all(messagesPromises);

            messagesToRender.filter(Boolean).forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender">${msg.senderName} (@${msg.senderUsername})</span>
                        <span class="message-time">${msg.time}</span>
                    </div>
                    <div class="message-text">${msg.content}</div>
                `;
                chatMessages.appendChild(messageDiv);
            });

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Se√ßilen medya dosyasƒ±nƒ± temizleme
        function clearMediaFile() {
            selectedMediaFile = null;
            document.getElementById('mediaFile').value = ''; 
            document.getElementById('selectedFileName').textContent = 'Dosya se√ßilmedi';
            document.getElementById('clearMediaFileBtn').style.display = 'none';
        }

        // Medya dosyasƒ± se√ßildiƒüinde
        document.getElementById('mediaFile').addEventListener('change', function(event) {
            if (event.target.files.length > 0) {
                selectedMediaFile = event.target.files[0];
                document.getElementById('selectedFileName').textContent = selectedMediaFile.name;
                document.getElementById('clearMediaFileBtn').style.display = 'inline-flex';
            } else {
                clearMediaFile();
            }
        });

        // Chat ID'yi bulma fonksiyonu - D√úZELTME
        async function findChatId() {
            if (!selectedBot) return null;

            try {
                // √ñnce mevcut g√ºncellemelerden chat ID bulmaya √ßalƒ±≈ü
                const updatesResponse = await fetch(`https://api.telegram.org/bot${selectedBot.token}/getUpdates?timeout=0&limit=100`);
                const updatesData = await updatesResponse.json();
                
                if (updatesData.ok && updatesData.result.length > 0) {
                    // En son mesajdan chat ID'yi al
                    for (let i = updatesData.result.length - 1; i >= 0; i--) {
                        const update = updatesData.result[i];
                        if (update.message && update.message.chat) {
                            return update.message.chat.id;
                        } else if (update.channel_post && update.channel_post.chat) {
                            return update.channel_post.chat.id;
                        } else if (update.callback_query && update.callback_query.message && update.callback_query.message.chat) {
                            return update.callback_query.message.chat.id;
                        }
                    }
                }
                return null;
            } catch (error) {
                console.error('Chat ID bulunurken hata olu≈ütu:', error);
                return null;
            }
        }

        // Mesaj g√∂nderme fonksiyonu - D√úZELTME
        async function sendMessage() {
            if (!selectedBot) return;

            const messageText = document.getElementById('messageText').value.trim();
            
            if (!messageText && !selectedMediaFile) {
                showStatus('L√ºtfen mesaj yazƒ±n veya bir dosya se√ßin', 'error');
                return;
            }

            setLoading('sendLoader', 'sendText', true);

            try {
                const chatId = await findChatId();

                if (!chatId) {
                    showStatus('Chat ID bulunamadƒ±. L√ºtfen √∂nce bota Telegram √ºzerinden bir mesaj g√∂nderin.', 'error');
                    setLoading('sendLoader', 'sendText', false);
                    return; 
                }

                let sendSuccess = false;

                if (selectedMediaFile) {
                    sendSuccess = await sendMedia(chatId, selectedMediaFile, messageText);
                    if (sendSuccess) {
                        clearMediaFile(); 
                        document.getElementById('messageText').value = ''; 
                    }
                } else if (messageText) { 
                    const sendResponse = await fetch(`https://api.telegram.org/bot${selectedBot.token}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: chatId, text: messageText })
                    });
                    const sendData = await sendResponse.json();
                    if (sendData.ok) {
                        document.getElementById('messageText').value = '';
                        showStatus('Mesaj g√∂nderildi', 'success');
                        sendSuccess = true;
                    } else {
                        showStatus('Mesaj g√∂nderilemedi: ' + (sendData.description || 'Bilinmeyen hata'), 'error');
                    }
                }

                if (sendSuccess) {
                    // Mesaj g√∂nderildikten sonra kƒ±sa bir s√ºre bekleyip yeni mesajlarƒ± √ßek
                    setTimeout(() => {
                        refreshMessages();
                    }, 1000); 
                }

            } catch (error) {
                showStatus('Mesaj g√∂nderirken hata olu≈ütu: ' + error.message, 'error');
            } finally {
                setLoading('sendLoader', 'sendText', false);
            }
        }

        // Medya g√∂nderme fonksiyonu
        async function sendMedia(chatId, file, caption = '') {
            const formData = new FormData();
            formData.append('chat_id', chatId);
            if (caption) {
                formData.append('caption', caption);
            }

            let apiMethod = '';
            let fileFieldName = ''; 

            if (file.type.startsWith('image/')) {
                apiMethod = 'sendPhoto';
                fileFieldName = 'photo';
            } else if (file.type.startsWith('audio/')) {
                apiMethod = 'sendAudio';
                fileFieldName = 'audio';
            } else if (file.type.startsWith('video/')) {
                apiMethod = 'sendVideo';
                fileFieldName = 'video';
            } else {
                apiMethod = 'sendDocument';
                fileFieldName = 'document';
            }

            formData.append(fileFieldName, file, file.name); 

            try {
                const response = await fetch(`https://api.telegram.org/bot${selectedBot.token}/${apiMethod}`, {
                    method: 'POST',
                    body: formData 
                });

                const data = await response.json();

                if (data.ok) {
                    showStatus(`Dosya (${file.name}) ba≈üarƒ±yla g√∂nderildi`, 'success');
                    return true;
                } else {
                    showStatus(`Dosya g√∂nderilemedi (${file.name}): ${data.description || 'Bilinmeyen hata'}`, 'error');
                    return false;
                }
            } catch (error) {
                showStatus(`Dosya g√∂nderirken hata olu≈ütu (${file.name}): ${error.message}`, 'error');
                return false;
            }
        }

        // Enter tu≈üu ile mesaj g√∂nderme
        document.getElementById('messageText').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault();
                sendMessage();
            }
        });

        // Enter tu≈üu ile bot ekleme
        document.getElementById('botToken').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBot();
            }
        });

        // Otomatik mesaj √ßekme (isteƒüe baƒülƒ±)
        function startAutoRefresh() {
            setInterval(() => {
                if (selectedBot) {
                    refreshMessages();
                }
            }, 10000); // Her 10 saniyede bir kontrol et
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', () => {
            loadBotsFromLocalStorage();
            updateBotList();
            
            // Otomatik yenilemeyi ba≈ülat (isteƒüe baƒülƒ±)
            // startAutoRefresh();
        });
    </script>
</body>
</html>